<!DOCTYPE html>
<html lang="en">
   <head>
      <title>New SBS Module Editor</title>
      <script src="../ace-builds/src-min/ace.js" type="text/javascript" charset="utf-8"></script>
      <script>
function modend(url)
{
   return url + "/module";
}

window.onload = function()
{
   var editor = ace.edit("editor");
   editor.setTheme("ace/theme/chrome");
   editor.session.setMode("ace/mode/lua");

   var editorelement = document.getElementById("editor");
   var endpoint = document.getElementById("endpoint");
   var token = document.getElementById("token");
   var modulename = document.getElementById("modulename");
   var loadbutton = document.getElementById("loadbutton");
   var savebutton = document.getElementById("savebutton");
   var commandbutton = document.getElementById("commandbutton");
   var commandname = document.getElementById("commandname");
   var commanddata = document.getElementById("commanddata");

   var saveInputs = function()
   {
      var data = {
         "endpoint" : endpoint.value,
         "modulename" : modulename.value,
         "token" : token.value
      };
      console.log("Caching inputs");
      window.localStorage.setItem("inputs", JSON.stringify(data));
      return data;
   };

   var loadInputs = function()
   {
      var data = window.localStorage.getItem("inputs");
      if(!data) return;
      console.log("Loading inputs from cache");
      data = JSON.parse(data);
      endpoint.value = data.endpoint;
      modulename.value = data.modulename;
      token.value = data.token;
   };

   //Load inputs
   loadInputs();

   loadbutton.addEventListener("click", function()
   {
      var data = saveInputs();
      var url = modend(data.endpoint) + "?names=" + data.modulename;
      if(confirm("You will lose saved data. Are you sure you want to load from " + url))
      {
         quickAJAX(url, data.token, function(d) 
         { 
            if(d.length) 
               editor.setValue(d[0].code); 
            else
               alert("Couldn't find any module named " + data.modulename);
         });
      }
   });
   savebutton.addEventListener("click", function()
   {
      var data = saveInputs();
      var url = modend(data.endpoint) + "/" + data.modulename;
      if(confirm("You will overwrite the module on the server. Are you sure you want to write " + 
                  data.modulename + " to " + url))
      {
         quickAJAX(url, data.token, null, null, { "name" : data.modulename, "code" : editor.getValue() });
      }
   });
   commandbutton.addEventListener("click", function()
   {
      var data = saveInputs();
      var url = modend(data.endpoint) + "/" + data.modulename + "/" + commandname.value;
      quickAJAX(url, data.token, function(d) 
      { 
         commandname.value = "";
         commanddata.value = "";
         console.log(d); 
      }, null, commanddata.value || " ");
   });

   var data = saveInputs();
   nextListen(data.endpoint, data.token, {"lastModuleId": 0}, document.getElementById("moduleoutput"));
};

function findUsername(users, uid)
{
   for(var i = 0; i < users.length; i++)
      if(users[i].id == uid)
         return users[i].username;
      
   return "???";
}

function nextListen(baseUrl, token, result, outputElement)
{
   if(result && result.moduleMessages)
   {
      console.log("Got module messages");
      for(var i = 0; i < result.moduleMessages.length; i++)
      {
         var elem = document.createElement("div");
         elem.className = "modulemessage";
         var elemmod = document.createElement("span");
         elemmod.className = "messagemodule";
         elemmod.textContent = "[" + result.moduleMessages[i].module + "]";
         var elemmsg = document.createElement("span");
         elemmsg.className = "messagecontent";
         var msg = result.moduleMessages[i].message;
         //This is BAD replacement: it will replace usernames with %id% repeatedly
         for(var j = 0; j < result.chains.user.length; j++)
            msg = msg.replace(new RegExp("%" + result.chains.user[j].id + "%","g"), result.chains.user[j].username);
         elemmsg.innerHTML = msg;
         var elemusr = document.createElement("span");
         elemusr.className = "messageuser";
         elemusr.textContent = "(" + findUsername(result.chains.user, result.moduleMessages[i].senderUid) + ")";
         elem.appendChild(elemmod);
         elem.appendChild(elemmsg);
         elem.appendChild(elemusr);
         outputElement.insertBefore(elem, outputElement.childNodes[0]);
      }
   }
   else
   {
      console.log("Module message timeout, continuing");
   }

   var moduleListen = { "lastId" : result.lastModuleId, "chains" : ["user.0usersInMessage.0senderUid.0receiverUid"]};
   var nextCall = function(r) { nextListen(baseUrl, token, r, outputElement); };
   quickAJAX(baseUrl + "/read/listen?modules="+encodeURIComponent(JSON.stringify(moduleListen)), token, nextCall);
}

function quickAJAX(url, token, callback, error, postData)
{
   error = error || function(e) { alert("Error on " + url + ":\n" + e.status + " - " + e.responseText); };
   var req = new XMLHttpRequest();
   req.addEventListener("loadend", function()
   {
      if(req.status <= 299 && req.status >= 200)
      {
         if(callback)
            callback(req.responseText ? JSON.parse(req.responseText) : null);
         else
            alert("Success: " + req.status + " - " + req.responseText);
      }
      else
      {
         error(req);
      }
   });
   req.open(postData ? "POST" : "GET", url);
   req.setRequestHeader("accept", "application/json");
   req.setRequestHeader("Authorization", "Bearer " + token);
   req.setRequestHeader("Content-Type", "application/json");
   if(postData)
      req.send(JSON.stringify(postData));
   else
      req.send();
}
      </script>
      <style type="text/css">
#editor
{
   width: 90%;
   height: 50em;
   border: 1px solid rgba(0,0,50,0.1);
}
#moduleoutput
{
   margin-top: 0.2em;
   background-color: #EEE;
   width: 90%;
   min-height: 5em;
   font-family: monospace;
   padding: 0.3em 0.5em;
}
.messagemodule
{
   color: #05F;
   margin-right: 0.5em;
}
.messageuser
{
   float: right;
   font-size: 0.8em;
   color: #777;
}
.annotation
{
   font-size: 0.75em;
   color: #777;
   margin: 0 0.5em;
}
      </style>
   </head>
   <body>
      <div id="editor">--Modules are written in Lua

--An example command. Commands must start with command_
--Commands are given the sender uid and string data (perhaps arguments/whatever)
function command_echo(uid, data)
    sendmessage(uid, data) --sendmessage is a builtin, sends message to given uid
end
      
--To read and write persistent data, use setdata and getdata
function command_store(uid, data)
   setdata("somekey", data)
   sendmessage(uid, "Stored " .. data .. " in 'somekey'") -- .. is string concat
end

function command_read(uid, data)
   sendmessage(uid, "You stored: " .. getdata("somekey"))
end

--You have no access to usernames or any user data. However, %UID% will be 
--captured, and the listener endpoint can chain against the field called
--"usersInMessage". The listener must manually replace the UIDs though
--(this is done to allow many types of configuration, such as nicknames, 
-- titles, special formatting (like links to usernames), etc. I'm sorry
-- it's more work, but I think it's neat if usernames could be linked 
-- in module messages, and manual replacement allows that)
function command_getuid(uid, data)
   sendmessage(uid, "UID " .. data .. " is %" .. data .. "%")
end

--Any string you return from a function will be given as the result
--text when POSTing the command. It should not be used to send messages
function command_alert(uid, data)
   sendmessage(uid, "Returned data in the response")
   return "The data was: " .. data
end

--You can define your own functions as long as they don't start with command_
function whatever()
   return 4
end


--Extra information:

-- Module endpoint is /api/module. Modules are standard objects like
-- content/etc, except there are no permissions. You can search for modules to get
-- the code, POST modules if you're a super user, and delete them (if you're super).
-- You can also POST data to a command endpoint. To post a command such as:
--   cgame draw 500
-- you would POST to endpoint (with body set to "500"):
--  /api/module/cgame/draw
-- If a command has no extra arguments, you can simply post an empty body (I think)

-- Modules can only send private messages for now. To listen for your module
-- messages, you can add ?modules to the listener endpoint along with your
-- actions/listeners/etc. The json looks like:
--   { "lastId" : 0, "chains" : ["0.usersInMessage"] }
-- where lastId uses the MODULE message id space (it's different than actions).
-- You can chain just like normal, the data are the module messages themselves.
-- The module messages result will be in "moduleMessages", and your chains are in
-- "chains" just as with actions and listeners. The result also now has a
-- "lastModuleId" field next to the "lastId" field so you can construct the next
-- long poll request more easily. "usersInMessage" will be all the parsed %UID%
-- found in the message, and you can also chain against "senderUid" and
-- "receiverUid" (although the receiver should technically always be you)

   </div>
   </body>
   <div id="controls">
      <div id="endpointcontrols">
         <input id="endpoint" placeholder="API Endpoint">
         <input id="token" placeholder="API token" type="password">
         <span class="annotation">Set/Edit = restart required (sorry)</span>
      </div>
      <div id="loadsavecontrols">
         <input id="modulename" placeholder="Module name">
         <button id="loadbutton">Load</button>
         <button id="savebutton">Save</button>
      </div>
      <div id="commandcontrols">
         <input id="commandname" placeholder="command">
         <input id="commanddata" placeholder="data">
         <button id="commandbutton">Send</button>
      </div>
   </div>
   <div id="moduleoutput">
   </div>
</html>
